---
// src/pages/guestbook.astro

// 1. DB ì—°ê²° ë„êµ¬ì™€ í…Œì´ë¸” ì •ì˜ ê°€ì ¸ì˜¤ê¸°
import { db } from '../db';
// ì´ë¦„ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ 'GuestbookTable'ì´ë¼ëŠ” ë³„ëª…ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
import { Guestbook as GuestbookTable } from '../db/schema'; 
import { desc } from 'drizzle-orm';

// --- [ì“°ê¸° ë¡œì§: INSERT] ---
// ì‚¬ìš©ìê°€ í¼ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤ (POST ìš”ì²­)
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const name = formData.get('name')?.toString();
  const message = formData.get('message')?.toString();

  if (name && message) {
    // DBì— ë°ì´í„°ë¥¼ ë„£ìŠµë‹ˆë‹¤.
    await db.insert(GuestbookTable).values({ name, message });
    console.log(`âœ… ë°ì´í„° ì €ì¥ ì™„ë£Œ: ${name} - ${message}`);
  }
}

// --- [ì½ê¸° ë¡œì§: SELECT] ---
// í˜ì´ì§€ê°€ ì—´ë¦´ ë•Œë§ˆë‹¤ ë¬´ì¡°ê±´ ì‹¤í–‰ë©ë‹ˆë‹¤.
// GuestbookTableì—ì„œ ë°ì´í„°ë¥¼ ë‹¤ ê°€ì ¸ì˜¤ë˜, ìµœì‹ ìˆœ(created_at ë‚´ë¦¼ì°¨ìˆœ)ìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
const messages = await db
  .select()
  .from(GuestbookTable)
  .orderBy(desc(GuestbookTable.createdAt));

console.log('ğŸ“¦ ê°€ì ¸ì˜¨ ë©”ì‹œì§€ ê°œìˆ˜:', messages.length);
---

<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ë°©ëª…ë¡</title>
</head>
<body class="bg-slate-50 p-10 max-w-2xl mx-auto font-sans">
  
  <div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold text-slate-800">ğŸ–Šï¸ DB ë°©ëª…ë¡</h1>
    <a href="/" class="text-blue-600 hover:underline">ğŸ  í™ˆìœ¼ë¡œ</a>
  </div>

  <!-- 1. ì…ë ¥ í¼ (ì´ê±¸ ì œì¶œí•˜ë©´ ìœ„ì˜ POST ë¡œì§ì´ ì‹¤í–‰ë¨) -->
  <form method="POST" class="bg-white p-6 rounded-xl shadow-md border border-slate-100 mb-10">
    <div class="mb-4">
      <label class="block text-sm font-bold text-slate-700 mb-2">ì´ë¦„</label>
      <input name="name" type="text" placeholder="ë‹‰ë„¤ì„" required class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </div>
    <div class="mb-4">
      <label class="block text-sm font-bold text-slate-700 mb-2">ë©”ì‹œì§€</label>
      <textarea name="message" placeholder="ë°©ëª…ë¡ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!" required class="w-full border border-slate-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 h-24"></textarea>
    </div>
    <button type="submit" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-sm">
      ë©”ì‹œì§€ ë‚¨ê¸°ê¸° âœ¨
    </button>
  </form>

  <!-- 2. ëª©ë¡ ì¶œë ¥ (SELECT ê²°ê³¼ ë¿Œë¦¬ê¸°) -->
  <div class="space-y-4">
    <!-- messages ë°°ì—´ì´ ë¹„ì–´ìˆìœ¼ë©´ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ -->
    {messages.length === 0 && (
      <p class="text-center text-slate-400 py-10">ì•„ì§ ë“±ë¡ëœ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!</p>
    )}

    <!-- ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë°˜ë³µë¬¸(map)ìœ¼ë¡œ ì¶œë ¥ -->
    {messages.map((msg) => (
      <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
        <div class="flex justify-between items-start mb-2">
          <span class="font-bold text-lg text-slate-800 flex items-center gap-2">
            ğŸ‘¤ {msg.name}
          </span>
          <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded-full">
            {msg.createdAt?.toLocaleString()}
          </span>
        </div>
        <p class="text-slate-600 leading-relaxed whitespace-pre-wrap">{msg.message}</p>
        {/* ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë³´ì—¬ì£¼ê¸° */}
        {msg.imageUrl && (
          <img src={msg.imageUrl} alt="ì²¨ë¶€ ì‚¬ì§„" class="mt-4 rounded-lg max-h-60 border" />
        )}
      
      </div>
    ))}
  </div>

</body>
</html>